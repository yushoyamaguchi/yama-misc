nodes:
- name: R1
  image: frr:centos-8-333cba65c4
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: R2#net0 }
  - { name: net1, type: direct, args: C1#net0 }
- name: R2
  image: frr:centos-8-333cba65c4
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: R1#net0 }
  - { name: net1, type: direct, args: C2#net0 }
- name: C1
  image: frr:centos-8-333cba65c4
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: R1#net1 }
- name: C2
  image: frr:centos-8-333cba65c4
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: R2#net1 }

node_configs:
- name: R1
  cmds:
    - cmd: sed -i 's/bgpd=no/bgpd=yes/' /etc/frr/daemons

    - cmd: sysctl -w 'net.ipv6.conf.all.forwarding=1'
    - cmd: sysctl -w 'net.ipv6.conf.all.disable_ipv6=0'
    - cmd: sysctl -w 'net.ipv6.conf.all.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.default.forwarding=1'
    - cmd: sysctl -w 'net.ipv6.conf.default.disable_ipv6=0'
    - cmd: sysctl -w 'net.ipv6.conf.default.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.lo.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.net0.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.net1.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv4.conf.all.rp_filter=0'
    - cmd: sysctl -w 'net.ipv4.conf.lo.rp_filter=0'
    - cmd: sysctl -w 'net.ipv4.conf.net0.rp_filter=0'
    - cmd: sysctl -w 'net.ipv4.conf.net1.rp_filter=0'

    - cmd: ip addr add 2001:ffff::1/64 dev net0
    - cmd: ip link add vrf100 type vrf table 100
    - cmd: ip link set vrf100 up
    - cmd: ip link set dev net1 vrf vrf100
    - cmd: ip addr add 2001:bb11::1/64 dev net1

    - cmd: /usr/lib/frr/frrinit.sh start

    - cmd: |
        vtysh -c 'conf t' \
          -c 'log file /tmp/frr.log' \
          -c 'debug bgp neighbor-events' \
          -c 'debug bgp zebra' \
          -c 'debug bgp vnc verbose' \
          -c 'debug bgp update-groups' \
          -c 'debug bgp updates in' \
          -c 'debug bgp updates out' \
          -c 'debug bgp vpn label' \
          -c 'debug bgp vpn leak-from-vrf' \
          -c 'debug bgp vpn leak-to-vrf' \
          -c 'debug bgp vpn rmap-event' \
          -c 'segment-routing' \
          -c ' srv6' \
          -c '  locators' \
          -c '   locator default' \
          -c '    prefix 2001:1111::/64' \
          -c '   exit' \
          -c '  exit' \
          -c ' exit' \
          -c 'router bgp 1' \
          -c ' bgp router-id 1.1.1.1' \
          -c ' no bgp ebgp-requires-policy' \
          -c ' no bgp default ipv4-unicast' \
          -c ' neighbor 2001:ffff::2 remote-as 2' \
          -c ' neighbor 2001:ffff::2 timers connect 1' \
          -c ' address-family ipv6 vpn' \
          -c '  neighbor 2001:ffff::2 activate' \
          -c ' exit-address-family' \
          -c ' segment-routing srv6' \
          -c '  locator default' \
          -c ' exit' \
          -c 'exit' \
          -c 'router bgp 1 vrf vrf100' \
          -c ' bgp router-id 1.1.1.1' \
          -c ' no bgp ebgp-requires-policy' \
          -c ' no bgp default ipv4-unicast' \
          -c ' neighbor 2001:bb11::2 remote-as 10' \
          -c ' neighbor 2001:bb11::2 timers connect 1' \
          -c ' address-family ipv6 unicast' \
          -c '  sid vpn export auto' \
          -c '  rd vpn export 1:100' \
          -c '  rt vpn export 99:99' \
          -c '  rt vpn import 99:99' \
          -c '  import vpn' \
          -c '  export vpn' \
          -c '  redistribute connected' \
          -c '  neighbor 2001:bb11::2 activate' \
          -c ' exit-address-family' \
          -c 'exit' \
          -c 'ipv6 route 2001:2222::/64 2001:ffff::2'

- name: R2
  cmds:
    - cmd: sed -i 's/bgpd=no/bgpd=yes/' /etc/frr/daemons

    - cmd: sysctl -w 'net.ipv6.conf.all.forwarding=1'
    - cmd: sysctl -w 'net.ipv6.conf.all.disable_ipv6=0'
    - cmd: sysctl -w 'net.ipv6.conf.all.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.default.forwarding=1'
    - cmd: sysctl -w 'net.ipv6.conf.default.disable_ipv6=0'
    - cmd: sysctl -w 'net.ipv6.conf.default.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.lo.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.net0.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv6.conf.net1.seg6_enabled=1'
    - cmd: sysctl -w 'net.ipv4.conf.all.rp_filter=0'
    - cmd: sysctl -w 'net.ipv4.conf.lo.rp_filter=0'
    - cmd: sysctl -w 'net.ipv4.conf.net0.rp_filter=0'
    - cmd: sysctl -w 'net.ipv4.conf.net1.rp_filter=0'

    - cmd: ip addr add 2001:ffff::2/64 dev net0
    - cmd: ip link add vrf100 type vrf table 100
    - cmd: ip link set vrf100 up
    - cmd: ip link set dev net1 vrf vrf100
    - cmd: ip addr add 2001:bb22::1/64 dev net1

    - cmd: /usr/lib/frr/frrinit.sh start

    - cmd: |
        vtysh -c 'conf t' \
          -c 'segment-routing' \
          -c ' srv6' \
          -c '  locators' \
          -c '   locator default' \
          -c '    prefix 2001:2222::/64' \
          -c '   exit' \
          -c '  exit' \
          -c ' exit' \
          -c 'router bgp 2' \
          -c ' bgp router-id 2.2.2.2' \
          -c ' no bgp ebgp-requires-policy' \
          -c ' no bgp default ipv4-unicast' \
          -c ' neighbor 2001:ffff::1 remote-as 1' \
          -c ' neighbor 2001:ffff::1 timers connect 1' \
          -c ' address-family ipv6 vpn' \
          -c '  neighbor 2001:ffff::1 activate' \
          -c ' exit-address-family' \
          -c ' segment-routing srv6' \
          -c '  locator default' \
          -c ' exit' \
          -c 'exit' \
          -c 'router bgp 2 vrf vrf100' \
          -c ' bgp router-id 2.2.2.2' \
          -c ' no bgp ebgp-requires-policy' \
          -c ' no bgp default ipv4-unicast' \
          -c ' neighbor 2001:bb22::2 remote-as 20' \
          -c ' neighbor 2001:bb22::2 timers connect 1' \
          -c ' address-family ipv6 unicast' \
          -c '  sid vpn export auto' \
          -c '  rd vpn export 2:100' \
          -c '  rt vpn export 99:99' \
          -c '  rt vpn import 99:99' \
          -c '  import vpn' \
          -c '  export vpn' \
          -c '  redistribute connected' \
          -c '  neighbor 2001:bb22::2 activate' \
          -c ' exit-address-family' \
          -c 'exit' \
          -c 'ipv6 route 2001:1111::/64 2001:ffff::1'

- name: C1
  cmds:
    - cmd: sed -i 's/bgpd=no/bgpd=yes/' /etc/frr/daemons

    - cmd: sysctl -w 'net.ipv6.conf.all.disable_ipv6=0'
    - cmd: ip addr add 2001:bb11::2/64 dev net0

    - cmd: /usr/lib/frr/frrinit.sh start

    - cmd: |
        vtysh -c 'conf t' \
          -c 'router bgp 10' \
          -c ' bgp router-id 1.1.0.0' \
          -c ' no bgp ebgp-requires-policy' \
          -c ' no bgp default ipv4-unicast' \
          -c ' neighbor 2001:bb11::1 remote-as 1' \
          -c ' address-family ipv6 unicast' \
          -c '  redistribute connected' \
          -c '  neighbor 2001:bb11::1 activate' \
          -c ' exit-address-family' \
          -c 'exit'

- name: C2
  cmds:
    - cmd: sed -i 's/bgpd=no/bgpd=yes/' /etc/frr/daemons

    - cmd: sysctl -w 'net.ipv6.conf.all.disable_ipv6=0'
    - cmd: ip addr add 2001:bb22::2/64 dev net0

    - cmd: /usr/lib/frr/frrinit.sh start

    - cmd: |
        vtysh -c 'conf t' \
          -c 'router bgp 20' \
          -c ' bgp router-id 2.2.0.0' \
          -c ' no bgp ebgp-requires-policy' \
          -c ' no bgp default ipv4-unicast' \
          -c ' neighbor 2001:bb22::1 remote-as 2' \
          -c ' address-family ipv6 unicast' \
          -c '  redistribute connected' \
          -c '  neighbor 2001:bb22::1 activate' \
          -c ' exit-address-family' \
          -c 'exit'
